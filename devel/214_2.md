# [214_2]

## 任务相关的代码文件
- 3rdparty/json-schema-validator/
- goldfish/liii/njson.scm
- src/goldfish.hpp
- tests/goldfish/liii/njson-test.scm
- xmake.lua
- xmake/packages/j/json_schema_validator/xmake.lua
- xmake/packages/n/nlohmann_json/xmake.lua
- devel/214_2.md

## 如何测试
```bash
xmake b goldfish
bin/goldfish tests/goldfish/liii/njson-test.scm
```

## 2026/2/25 引入json-schema-validator并在 njson 中新增 JSON Schema 校验能力

### What
1. 构建与依赖：
   在 `xmake.lua` 新增 `json_schema_validator` 依赖（`2.4.0`），并接入 `goldfish` 与 `goldfish_repl_wasm` 目标。
   删除了`.github` `.distro` `test` `example`目录及相关无用文件。
2. 本地包引入：
   新增 `xmake/packages/j/json_schema_validator/xmake.lua`，通过 `set_sourcedir(...)` 指向 `3rdparty/json-schema-validator`，构建时不依赖远程拉取。
3. 依赖兼容性处理：
   在 `xmake/packages/n/nlohmann_json/xmake.lua` 中补充 `nlohmann_jsonConfig.cmake` 与 `nlohmann_jsonConfigVersion.cmake`，保证 schema-validator 的 CMake 查找和项目内 `nlohmann_json` 版本一致。
4. C++ 运行时能力：
   在 `src/goldfish.hpp` 新增 `g_njson-schema-valid?` 原语（对应 `f_njson_schema_valid_p`），将 schema 校验能力暴露给 Scheme。
5. Scheme API：
   在 `goldfish/liii/njson.scm` 导出 `njson-schema-valid?`，并新增 `njson-json-value?` 统一复用“严格 JSON 值”参数检查逻辑。
6. 测试扩展：
   在 `tests/goldfish/liii/njson-test.scm` 新增一组 schema 校验功能测试，覆盖通过、失败、schema 非法、参数类型错误、句柄释放后访问等路径。

### Why
1. 需要在 `njson` 中直接支持 JSON Schema 校验，避免业务层自行拼装复杂校验逻辑。
2. 需要保持依赖可离线构建、可复现，避免构建过程动态下载第三方源码。
3. 需要避免 `json-schema-validator` 和 `nlohmann_json` 版本不一致带来的 ABI/链接问题。
4. 需要把错误语义区分清楚：数据不匹配返回 `#f`，schema/参数错误抛异常。

### How
1. 依赖层：
   `json_schema_validator` 包通过 CMake 构建，关闭 tests/examples，仅安装库本体；显式设置 `nlohmann_json_DIR` 和 `CMAKE_PREFIX_PATH` 指向本项目依赖安装目录。
2. C++ 原语层：
   `f_njson_schema_valid_p` 先把 `schema` 与 `instance` 转换为 `nlohmann::json`，再执行：
   - `validator.set_root_schema(schema_json)`：schema 非法时抛 `schema-error`。
   - `validator.validate(instance_json, err_handler)`：校验失败通过 error handler 反映，返回 `#f`；运行时异常抛 `validation-error`。
3. Scheme 封装层：
   `njson-schema-valid?` 先校验参数类型，再调用 `g_njson-schema-valid?`，保证调用方拿到稳定可读的错误信息。
4. 测试层：
   补充以下关键场景：
   - `additionalProperties=false` 下额外字段失败；
   - 可选字段缺失仍通过；
   - 根类型不匹配（object schema 对 array 实例）；
   - array schema 的 `items` 约束；
   - 标量 schema（`integer` / `null`）；
   - 非法 schema（`required: 1`、根非 object）；
   - 非法 instance 输入（symbol/list）；
   - 已 `free` 句柄再次参与校验。

## 验证结果
本次文档编写前已执行：
1. ✅ `xmake b goldfish` 通过。
2. ✅ `bin/goldfish tests/goldfish/liii/njson-test.scm` 通过。


